version: '3.7'
services:
  # TODO Security enhancement - move env file to docker secrets
  web:
    build: .
    container_name: flask-web
    working_dir: /var/www
    restart: unless-stopped
    env_file:
      - ./.env
    expose:
      - 5000
    volumes:
      - .:/var/www/
    depends_on:
      - mongo-db-1
      - redis
    networks:
      - backend
      - frontend

  mongo-db-1:
    # TODO upgrade mongo-db version
    # TODO Security - Do not expose the Database Port by default
    image: mongo:4.2.8-bionic
    container_name: mongo-db-1
    restart: unless-stopped
    env_file:
      - ./.env
    ports:
      - "27017:27017"
    volumes:
      - ./env/mongo/init/:/docker-entrypoint-initdb.d/
    networks:
      - backend
      - elastic
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo mongo-db-1:27017/test --quiet
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mongo-db-replica-setup:
    # TODO upgrade mongo-db version
    image: mongo:4.2.8-bionic
    env_file:
      - ./.env
    links:
      - mongo-db-1:mongo-db-1
    depends_on:
      - mongo-db-1
    networks:
      - backend
    volumes:
      - ./scripts/database/mongo_replica_set_setup.sh:/scripts/mongo_replica_set_setup.sh
    restart: "no"
    entrypoint: [ "bash", "./scripts/mongo_replica_set_setup.sh" ]

  elasticsearch-mongo-connector:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_mongo_connector
    container_name: elasticsearch-mongo-connector
    depends_on:
      - mongo-db-1
      - elasticsearch-worker-1
      - kibana
    volumes:
      - ./requirements/requirements_mongo_connector.txt:/var/www/requirements_mongo_connector.txt
      - ./env/mongo-connector/mongo-connector-config.json:/var/www/mongo-connector-config.json
    env_file:
      - ./.env
    networks:
      - backend
      - elastic

  elasticsearch-worker-1:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: elasticsearch-worker-1
    restart: unless-stopped
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD-SHELL", "curl --silent --fail localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 30s
      retries: 3
    depends_on:
      - mongo-db-1
    networks:
      - elastic

  kibana:
    container_name: kibana
    restart: unless-stopped
    image: docker.elastic.co/kibana/kibana:7.12.1
    ports:
      - "127.0.0.1:5601:5601"
    depends_on:
      - elasticsearch-worker-1
    environment:
      - ELASTICSEARCH_HOSTS="http://elasticsearch-worker-1:9200"
    networks:
      - elastic

  nginx:
    container_name: nginx-frontend
    build:
      context: ./
      dockerfile: Dockerfile_NGINX
    restart: unless-stopped
    depends_on:
      - web
    volumes:
      - ./env/nginx:/etc/nginx/conf.d
      - ./env/certbot/conf:/etc/letsencrypt
      - ./env/certbot/www:/var/www/certbot
      - ./env/elasticsearch/kibana.htpasswd:/var/www/kibana.htpasswd
      - ./firmware-droid-client/build:/usr/share/nginx/build
    ports:
      - "80:80"
      - "443:443"
      - "5602:5602"
    networks:
      - frontend
      - elastic

  redis:
    # TODO upgrade redis version
    image: redis:6-buster
    container_name: redis
    command: redis-server
    ports:
      - "127.0.0.1:6379:6379"
    networks:
      - backend

  firmware-worker:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_firmware
    container_name: firmware-worker
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ./.env
    command: rqworker --name firmware-worker --url redis://redis:6379/ high
    networks:
      - backend
    # TODO Security enhancement / compatibility - replace/remove access right
    privileged: true

  firmware-worker-high-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_firmware
    container_name: firmware-worker-high-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ./.env
    command: rqworker --name firmware-worker-high-1 --url redis://redis:6379/ high
    networks:
      - backend
    # TODO Security enhancement / compatibility - replace/remove access right
    privileged: true

  fuzzyhash-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_fuzzyhash
    container_name: fuzzyhash-worker-1
    restart: unless-stopped
    depends_on:
      - redis
      - firmware-worker
    volumes:
      - .:/var/www/
      - /var/run/docker.sock:/var/run/docker.sock
    env_file:
      - ./.env
    command: rqworker --name fuzzyhash-worker-1 --url redis://redis:6379/ fuzzyhash
    networks:
      - backend
    # TODO Security enhancement / compatibility - replace/remove access right
    privileged: true

  firmware-worker-default-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_firmware
    container_name: firmware-worker-default-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name firmware-worker-default-1 --url redis://redis:6379/ default
    networks:
      - backend

  androguard-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_androguard
    container_name: androguard-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name androguard-worker-1 --url redis://redis:6379/ androguard
    networks:
      - backend

  androwarn-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_androwarn
    container_name: androwarn-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name androwarn-worker-1 --url redis://redis:6379/ androwarn
    networks:
      - backend

  apkid-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_apkid
    container_name: apkid-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name apkid-worker-1 --url redis://redis:6379/ apkid
    networks:
      - backend

  exodus-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_exodus
    container_name: exodus-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name exodus-worker-1 --url redis://redis:6379/ exodus
    networks:
      - backend

  frida-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_frida
    container_name: frida-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name frida-worker-1 --url redis://redis:6379/ frida
    networks:
      - backend

  qark-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_qark
    container_name: qark-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name qark-worker-1 --url redis://redis:6379/ qark
    networks:
      - backend

  quark_engine-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_quark_engine
    container_name: quark_engine-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name quark_engine-worker-1 --url redis://redis:6379/ quark_engine
    networks:
      - backend

  super-android-analyzer-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_super_android_analyzer
    container_name: super_android_analyzer-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name super_android_analyzer-worker-1 --url redis://redis:6379/ super_android_analyzer
    networks:
      - backend

  virustotal-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_virustotal
    container_name: virustotal-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name virustotal-worker-1 --url redis://redis:6379/ virustotal
    networks:
      - backend

  apkleaks-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_apkleaks
    container_name: apkleaks-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name apkleaks-worker-1 --url redis://redis:6379/ apkleaks
    networks:
      - backend

  libradar-worker-1:
    build:
      context: .
      dockerfile: ./docker/base/Dockerfile_libradar
    container_name: libradar-worker-1
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - .:/var/www/
    env_file:
      - ./.env
    command: rqworker --name libradar-worker-1 --url redis://redis:6379/ libradar
    networks:
      - backend

networks:
  frontend:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
  backend:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
  elastic:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
