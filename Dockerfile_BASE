########################################################
# Firmwaredroid docker core                            #
########################################################
FROM python:3.11-slim-bookworm AS firmwaredroid-base

RUN mkdir -p /var/www/tmp/ && mkdir -p /var/www/ && mkdir -p /opt/firmwaredroid/python/
ADD ./ /var/www/
WORKDIR /var/www/
ENV PATH="$PATH:/home/www/.local/bin/"
ENV PATH="$PATH:/var/www/source/"
ENV PYTHONPATH="/var/www/source/:\$PYTHONPATH"
########################################################
# Update installation                                  #
########################################################
RUN apt-get --allow-releaseinfo-change update -y && \
    apt-get -y install --no-install-recommends apt-utils && \
    apt-get -y install tar gzip build-essential git unzip curl wget sudo

########################################################
# User generation                                      #
########################################################
ENV GROUP_ID=1000 \
    USER_ID=1000
RUN groupadd -r www -g $GROUP_ID
# /sbin/nologin -> Debug with -s /bin/sh to get shell
RUN useradd -r -g $GROUP_ID -u $USER_ID www -s /bin/sh -m
RUN chown $USER_ID:$GROUP_ID /var/www/
RUN chown -R $USER_ID:$GROUP_ID /opt/firmwaredroid/

##################################################
# Install RUST for root user                       #
##################################################
RUN set -eux; \
    for i in $(seq 1 5); do \
        curl -fsSL https://sh.rustup.rs -o rustup.sh && break || sleep 15; \
    done; \
    for i in $(seq 1 5); do \
        sh rustup.sh -y && break || sleep 15; \
    done; \
    rm rustup.sh
#RUN curl https://sh.rustup.rs -sSf | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN cargo --version

##################################################
# Install RUST for www user                       #
##################################################
USER www
WORKDIR /home/www
RUN set -eux; \
    for i in $(seq 1 5); do \
        curl -fsSL https://sh.rustup.rs -o rustup.sh && break || sleep 15; \
    done; \
    for i in $(seq 1 5); do \
        sh rustup.sh -y && break || sleep 15; \
    done; \
    rm rustup.sh
ENV PATH="/home/www/.cargo/bin:${PATH}"

################################################
WORKDIR /var/www/
ENV PATH="/home/www/.local/bin/:$PATH"

########################################################
# Install Python dependencies                          #
########################################################
RUN python3 -m pip install --upgrade pip && pip install -r ./requirements.txt
RUN chown -R $USER_ID:$GROUP_ID /opt/firmwaredroid/










