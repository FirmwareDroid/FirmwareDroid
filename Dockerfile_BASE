########################################################
# Firmwaredroid docker core                            #
# Base dependency for docker workers                   #
########################################################
FROM python:3.8-buster as firmwaredroid-base

########################################################
# Apt installation                                     #docker
########################################################
RUN apt-get update -y && \
    apt-get -y install --no-install-recommends apt-utils && \
    apt-get -y install liblzo2-dev

########################################################
# User generation                                      #
########################################################
WORKDIR /var/www/
ENV GROUP_ID=1000 \
    USER_ID=1000
# Add local user
RUN groupadd -r www -g $GROUP_ID
RUN useradd -r -g $GROUP_ID -u $USER_ID www -s /bin/sh -m
RUN chown $USER_ID:$GROUP_ID /var/www/

########################################################
# Python requirements                                  #
########################################################
COPY requirements.txt ./requirements.txt
RUN /usr/local/bin/python -m pip install --upgrade pip
RUN --mount=type=cache,target=/tmp/.cache \
    pip install -r requirements.txt

########################################################
# Code generation                                      #
########################################################
# Copy main application
COPY . /var/www/

USER $USER_ID:$GROUP_ID